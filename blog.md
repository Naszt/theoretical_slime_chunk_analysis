# 史莱姆区块课题〔1〕：基本原理与 2×n 联寻找

## 前言

我们知道，在 Minecraft 中史莱姆是一种很重要的生物，查看 wiki 可以发现：
> 史莱姆生成在40层以下的特定的“史莱姆区块”里（不限亮度）。

于是想要制造高效率的史莱姆农场就需要一片较大的多联史莱姆区块。  
但是由于现版本渗浆药水的存在，该任务就变成了一个纯粹的理论课题。

*※ 本文主要的代码语言是 c++ 风格，这比较简洁高效。*  
*※ 本文将会不断更新，会尽量满足各种水平的人阅读。*

## 核心想法

为了方便普罗大众的理解，我先给出一个较为浅显的理解方式：

对于史莱姆区块的判定，你可以理解为这是一个可以分离变量的函数：
$${\rm CheckSlimeChunk}(seed,x,z)=H(seed+f(x)+g(z))$$

这里的 $seed,x,z$ 分别指的是 世界种子，区块 X 轴坐标，区块 Z 轴坐标。  
于是我们可以定义：
$${\rm Check}(c,z)=H(c+g(z))$$

那么固定一个 $c$，我们就得到了一列史莱姆区块，  
我们把这列史莱姆区块称为编号为 $c$ 的史莱姆列。

由于 $f(x)$ 是 $[-2^{31},2^{31}-1]$ 到 $[-2^{32},2^{32}-2]$ 的单射，对于种子 $seed$，  
它就是选择一半 $c=[seed-2^{32},seed+2^{32}-2]$ 的史莱姆列，重新排列后的结果。

也就是说只要我们找到了两个史莱姆列，它们并在一起可以产生 $2\times n$ 联的史莱姆区块，  
我们就尝试可以求解 $seed,x$，得到真正的 $2\times n$ 联的史莱姆区块。

## 技术细节

### 史莱姆区块的判定

查看 wiki，我们能知道史莱姆区块的判定代码：

```java
import java.util.Random; 

public class CheckSlimeChunk { 

    public static boolean isSlimeChunk(long worldSeed,     // 世界种子，一个64位整数，可以通过/seed获取
                                       int  chunkX,        // 区块X轴坐标，32位整数
                                       int  chunkZ) {      // 区块Z轴坐标，32位整数
        Random rng = new Random(
                        worldSeed +
                        (long)(chunkX * chunkX * 4987142) +
                        (long)(chunkX * 5947611) +
                        (long)(chunkZ * chunkZ) * 4392871L +
                        (long)(chunkZ * 389711) ^ 987234911L
        );
        return rng.nextInt(10) == 0;
    }
}
```

可以注意到区块 $(x,z)$ 是史莱姆区块的概率为 $1/10$。  
因此某个 $n$ 个区块的特定图案均为史莱姆区块的概率仅为 $10^{-n}$。  
如果纯粹暴力的寻找，期望时间复杂度为 $O(n10^n)$。

仔细观察这个函数，你会发现很多坑人的细节：

1. 函数中的乘法都是先有符号 $32$ 位溢出，除了 `*4392871L` 要整形提升。
2. Java 的有符号 $32$ 位溢出是 `-fwrapv` 的回绕溢出。

`Random()` 的实现可以看做（c++ 风格）：  
`rng=(rng^Ox5DEECE66D)&((1LL<<48)-1);`  

`nextInt(10)` 的实现可以看做：  
`next()=rng: rng=((rng*0x5DEECE66D+11)&((1LL<<48)-1))>>17;`  
`nextInt(10)=rng%10: while(next()>=2147483640);`  

$$\red{\Large\mathtt{TODO.}}$$

但是满足 `rng>=2147483640` 的情况只有 $8$ 个，我们可以直接看做：  
`nextInt(10)=(((rng*0x5DEECE66D+11)&((1LL<<48)-1))>>17)%10;`

$$\red{\Large\mathtt{TODO.}}$$

---
### 判定函数的数学分析

正如上文所述，我们可以分离变量：
$${\rm CheckSlimeChunk}(seed,x,z)=H(seed+f(x)+g(z))$$

这里我们具体分析一下，整个讨论都是整数意义下的，后文就不再赘述了。  

由于 $H(x)$ 过于复杂我们先不做讨论。  
定义 $R(x)$ 为 `-fwrapv` 意义下 32 位有符号整数的溢出:
$$
\begin{aligned}
R(x)&=\begin{cases}
x\bmod2^{32}, &x\bmod2^{32}<2^{31}\\
x\bmod2^{32}-2^{32}, &x\bmod2^{32}\ge2^{31}
\end{cases}
\end{aligned}
$$

该运算和 $\bmod$ 运算性质很像，满足 $R(a+b)=R(R(a)+R(b))$，  
但注意 $R(a)+R(b)\neq R(R(a)+R(b))$，  
于是 $f(x),g(x)$ 为：
$$
\begin{aligned}
f(x)&=R(4987142x^2)+R(5947611x)\\
g(x)&=4392871R(x^2)+R(389711x)\\
\end{aligned}
$$

根据代码，$f,g$ 的定义域都是 $[-2^{31},2^{31}-1]$，  
根据 $R(x)$ 的性质，$f$ 的值域属于 $[-2^{32},2^{32}-2]$，但 $g$ 的值域相当大。  

---

接下来我们用反证法证明 $f,g$ 都是单射。

若存在 $f(x)=f(y)$，则：
$$
\begin{aligned}
f(x)&\equiv f(y)\pmod{2^{32}}\\
4987142(x^2-y^2)+5947611(x-y)&\equiv0\pmod{2^{32}}\\
(x-y)(4987142(x+y)+5947611)&\equiv0\pmod{2^{32}}\\
\end{aligned}
$$
由于 $4987142(x+y)-5947611$ 恒为奇数，  
因此 $2^{32}\mid x-y$，矛盾，无解。

$g(x)$ 的不会证，但我写代码验证了（雾）。

---
### 思路

正如上文所述，我们可以定义编号为 $c$ 的史莱姆列，这一列的数组为：
$$P_c[z]=H(c+g(z))$$
不妨让 $z\in[0,B]$，我们只去判定这些史莱姆区块。  
连续 $n$ 项都为 $1$ 的概率只有 $10^{-n}$，我们可以将这 $O(B10^{-n})$ 项记录下来。

如果有两列 $c_1,c_2$ 记录了同样的 $z$，  
这意味着如果把这两列并在一起，我们就找到了一个 $2\times n$ 联的史莱姆区块。  
只要解出该方程的 $seed,x$ 即可。
$$\begin{cases}
seed+f(x)=c_1\\
seed+f(x+1)=c_2
\end{cases}$$

根据上文分析，一个种子会产生 $2^{32}$ 个不同的 $c$。  
简单分析可以发现，一个种子会产生略小于 $2^{31}$ 个不同的 $c_2-c_1$。  
交换 $c_1,c_2$，这样就有 $2^{32}$ 个不同的 $c_2-c_1$ 了。  
于是找不到解的概率只有 $\frac12$。

对于种子 $seed$，它就是选择一半 $c=[seed-2^{32},seed+2^{32}-2]$ 的史莱姆列，重新排列后的结果。  
因此对于一对 $c_1-c_2\in[-2^{32},2^{32}]$，期望能找到一组 $seed,x$。  

如果我们考虑对行计算 $H(f(x)+c')$，我们就需要解 $g(x)$，  
同样的分析，对于 $\frac{c_1-c_2}{4392871}\in[-2^{31},2^{31}]$，期望只能找到 $\frac{2}{4392871}$ 组解，  
这个概率太低了，因此我们不采用这种方式。

---
我们具体分析一下“时间复杂度”：  

对于某一列来说，要判断 $B+1$ 个位置，记录的项只有 $B-n$ 种可能。  
我们令 $c$ 是从 $0$ 开始递增的，花费 $O(c(B+1))$ 的时间，期望记录 $\frac{c(B-n)}{10^n}$ 个数字。  
具体时间复杂度要分两类讨论：

当 $c<2^{33}$ 时：  
期望能找到 $\frac{c^2(B-n)}{2\times10^{2n}}$ 组 $c_1,c_2$，相当于有 $\frac{c^2(B-n)}{2\times10^{2n}}$ 组解。  
换句话说就是画花 $T$ 的时间，找到 $\frac{T^2(B-n)}{2\times10^{2n}B^2}$ 组解。  
此时取 $B=2n$ 最优，能找到 $\frac{T^2}{8n\times10^{2n}}$ 组解。  

当 $c\ge2^{33}$ 时：  
$c$ 递增到 $c_0$ 时，我们需要删掉 $c'<c_0-2^{33}$ 的 $c'$，  
期望能找到 $\frac{2^{65}c(B-n)^2}{10^{3n}}$ 组 $c_1,c_2$，相当于有 $\frac{2^{65}c(B-n)^2}{10^{3n}}$ 组解。  
换句话说就是画花 $T$ 的时间，找到 $\frac{2^{65}T(B-n)^2}{10^{3n}B}$ 组解。  
此时取 $B\to\infty$ 最优。  
*※ 感觉这一部分分析的有问题，求大佬们捞捞。*

---
### 解方程

$$
\begin{aligned}
&\begin{cases}
seed+f(x)=c_1\\
seed+f(x+1)=c_2
\end{cases}\\
\Rightarrow\ &f(x+1)-f(x)\equiv c_2-c_1\pmod{2^{32}}
\end{aligned}
$$

$$
\begin{aligned}
f(x)&=R(4987142x^2)+R(5947611x)\\
\Rightarrow f(x)&\equiv4987142x^2+5947611x\pmod{2^{32}}\\
\Rightarrow f(x+1)-f(x)&\equiv9974284x+10934753\pmod{2^{32}}
\end{aligned}
$$

定义 $\delta=c_2-c_1$，于是：
$$\delta\equiv9974284x+10934753\pmod{2^{32}}$$
由于 $v_2(9974284)=2$，方程有解一个必要条件是 $\delta\equiv1\pmod4$，解：
$$x_0\equiv\frac{\delta-10934753}{9974284}\equiv381395499\frac{\delta-10934753}4\pmod{2^{30}}$$

由于 $x\in[-2^{31},2^{31}-1]$，因此我们只用判断这 $4$ 个解是否正确即可：
$$x_0-2^{31},x_0-2^{30},x_0,x_0+2^{30}$$

由于 $f(x)\in[-2^{32},2^{32}-2]$，  
这四个解要么就是 $\delta\bmod 2^{32}$，要么就是 $\delta\bmod 2^{32}+2^{32}$。

总而言之，对于某个 $\delta$，有 $\frac14$ 的概率有解，有解时期望有 $2$ 个解。  
考虑 $-\delta$，这里也能分析出期望有一个解。  
如果把 $f$ 换成 $g$ 这个方法就不行了，分析同上，$g$ 有解的概率太低了。

# 史莱姆区块课题〔2〕：筛 $6$ 长迪克

## 数据


这是一个 $2\times12$ 的：
```txt
seed=2587795608,x=549589440,z=106304
```


这是筛 $6$ 长迪克的：  
其中区块 $z$ 属于 $[-10^7,10^7]$，   
筛了 $c$ 属于 $[0,1.46\times10^7]$，跑了十多个小时。

```txt
seed=-3466374598,x=14680071296,z=-147922272
seed=436220050,x=7020086480,z=109260464
seed=956101480,x=16843240128,z=-23235168
seed=1228429479,x=8974126416,z=-142634992
seed=967684935,x=3285026768,z=123983856
seed=1223269912,x=14030865040,z=11244544
seed=1207711452,x=10633633168,z=104306608
seed=130489462,x=845809728,z=58096400
seed=1362850584,x=396851584,z=-43723600
seed=-3462558384,x=14680071296,z=-54295728
seed=43750008,x=6254610240,z=-127820000
seed=-650751580,x=7936205248,z=-39341328
seed=2289318893,x=10840026864,z=-126256080
seed=-2012049829,x=16351745200,z=-81811376
seed=-1054375186,x=15679279424,z=96553456
seed=2011318219,x=5996440704,z=-79238368
seed=-861242840,x=6977942400,z=-109534656
seed=1541858000,x=14017747120,z=-27392464
seed=-1431346647,x=521361616,z=-159630800
seed=967671091,x=8286124448,z=36407232
seed=3747855043,x=14651176048,z=157656368
seed=-1380033426,x=14112624688,z=-100192816
seed=94683782,x=13962485120,z=68437136
seed=455887669,x=5434395600,z=-29349968
seed=-3674515964,x=8214182576,z=154452224
seed=2005730532,x=13772523264,z=112089120
seed=2491510115,x=13414922080,z=106031424
seed=-883537678,x=12731853120,z=121150112
seed=566410148,x=9158562752,z=-130019616
seed=-2961650083,x=10383056048,z=-95967456
seed=1423479709,x=13541788384,z=61025888
seed=1472796915,x=8685387440,z=-156053312
seed=-94845972,x=1097296272,z=-13109072
seed=-1503589990,x=4589398832,z=-132452992
seed=-1821601166,x=16853099248,z=-152344080
seed=-2788949652,x=1166103360,z=-61729600
seed=2136888187,x=14805897248,z=97339392
seed=705727290,x=6477890496,z=-95383136
seed=-2977587898,x=16860691648,z=-51372400
seed=-704419670,x=12498424384,z=105301648
seed=1783362093,x=16513218272,z=16796688
seed=-1821611130,x=1736078464,z=5487824
seed=-416043336,x=10566631168,z=-27716320
seed=-3458790272,x=14680071296,z=18300128
seed=2565325126,x=12787934992,z=14184848
seed=-1986665912,x=14071293600,z=27152192
seed=3343222734,x=3353454912,z=33687280
seed=4034383331,x=2488650368,z=44785008
seed=275811600,x=9739382192,z=150230112
seed=656655359,x=1741438640,z=-138301120
seed=-1000181232,x=8600114048,z=71556688
seed=-2252536198,x=4543651456,z=69733856
seed=-3962195711,x=464342736,z=13394368
seed=-303341147,x=15731323952,z=124771200
seed=1325720842,x=16406979648,z=-11492528
seed=2451076959,x=7323872480,z=48481792
seed=-519852213,x=3233457616,z=2893152
seed=1457410919,x=5733896240,z=-32513568
seed=-1684332454,x=16572634752,z=-104461520
seed=-3735841406,x=14931812784,z=49521792
seed=1738685698,x=12051360896,z=-148712512
seed=-2413108705,x=3019271712,z=-42559136
seed=2737328336,x=1173861120,z=41720672
seed=-540766234,x=1428523808,z=-7888656
seed=-981942948,x=3354481472,z=124986736
seed=1879601995,x=5874555632,z=-38417488
seed=-1554137997,x=16940770224,z=100402144
seed=-1760376038,x=11801644992,z=-16236880
seed=2749922652,x=420138656,z=51147760
seed=1691337213,x=9716232912,z=76009744
seed=711236212,x=5978734272,z=38510128
seed=-374863056,x=8855631056,z=-29086528
seed=-1593222074,x=9948766016,z=-64513376
seed=-3907136924,x=1364339712,z=-69259488
seed=500487545,x=8692159968,z=-10849136
seed=587583916,x=8601140608,z=-53657168
seed=-220083322,x=1766392992,z=35113104
seed=1442269170,x=293795968,z=-144798816
seed=877117356,x=9098794912,z=-79030704
seed=2246263507,x=12236644656,z=-128253088
seed=971275465,x=10217745424,z=15716256
seed=-1515235742,x=882552320,z=137273552
seed=-197057535,x=7479882064,z=50591296
seed=-1049314108,x=15679279424,z=-150088928
seed=-922350224,x=15798932256,z=-32984752
seed=-54700427,x=14261345008,z=-20973856
seed=-865279630,x=15852520064,z=155182352
seed=116409528,x=13169277952,z=-12045792
seed=3413395120,x=13305397072,z=16137888
seed=2125193120,x=1889132384,z=-47491232
seed=643718600,x=2757064832,z=45386432
seed=-985773511,x=11994479824,z=-113220736
seed=2738540116,x=1173861120,z=97841568
seed=-1670067229,x=9875246400,z=-125911984
seed=-1634466574,x=7802621520,z=70908704
seed=3103669440,x=14581680000,z=-141422816
seed=342766983,x=9503418064,z=-133204800
seed=936553588,x=8291312368,z=45037632
seed=-224855303,x=4905958288,z=-79849120
seed=3373288331,x=3958326192,z=-62596000
seed=-1724438170,x=15173901824,z=-109959440
seed=-855574110,x=6977942400,z=-138880896
seed=-1728425970,x=14178262528,z=-92236768
seed=3229960252,x=12603588240,z=55159136
seed=1780254142,x=1914644800,z=-88088912
seed=-2440972836,x=11558639616,z=-126158544
seed=-590968081,x=2049771808,z=-2358336
seed=11603657,x=16757966752,z=93548064
seed=-979899424,x=3354481472,z=-47264864
seed=1526608131,x=5932284144,z=61219632
seed=1712487293,x=1891833136,z=-47491232
seed=-177667566,x=16226787344,z=-78977920
seed=1824358436,x=1853809056,z=-63400480
seed=-2822836252,x=10157770880,z=-117236608
seed=447701951,x=14153652656,z=-132434448
seed=1237493071,x=10203552720,z=-34432720
seed=-3656045501,x=1292184240,z=81106688
seed=-22664116,x=11567768416,z=35929888
seed=2218036915,x=11392681344,z=-60982368
seed=3236609798,x=15010534080,z=12231824
seed=1454874468,x=16085218496,z=-122797872
seed=2708269818,x=5438894560,z=134479008
seed=-2822264020,x=10157770880,z=23573152
seed=1517249309,x=7987181904,z=132566240
seed=-1001053370,x=3304283392,z=144795712
seed=1693748834,x=207626928,z=-58846592
seed=-1352972576,x=9257980608,z=139057600
seed=363292959,x=1295573968,z=-73407232
seed=-117879689,x=8825488784,z=-21892976
seed=-1046739550,x=15679279424,z=106038000
seed=1388142753,x=2611437984,z=-138572368
seed=762919317,x=12001369488,z=139696192
seed=-2676971149,x=1914383024,z=70581712
seed=-834041651,x=5909754928,z=133125856
seed=-2729310592,x=17121086560,z=72246336
seed=-2576293995,x=12231077824,z=77187792
seed=-1423948470,x=1152771856,z=39611168
seed=-2834079832,x=11780838208,z=-56890464
seed=3388781706,x=120424448,z=-62862560
seed=165175071,x=7494929088,z=-47957712
seed=290455613,x=14070225680,z=29827456
seed=-1716730705,x=8079310480,z=156397536
seed=1071241058,x=1145634160,z=157276064
seed=951586192,x=2032368512,z=35075760
seed=325032509,x=12614728816,z=-110337648
seed=-919260074,x=6189702720,z=46167616
seed=786828132,x=16965724608,z=20496544
seed=3424844194,x=16966544480,z=-8854240
seed=-2424051836,x=6038398784,z=123021456
seed=2406943801,x=17067932768,z=-447168
seed=-1993761518,x=10743647360,z=-136421072
seed=1164450349,x=14682558480,z=145341328
seed=-2304857014,x=8584639856,z=92565328
seed=518881432,x=12762298560,z=79886432
seed=967635816,x=16843240128,z=-23235168
seed=1789437856,x=12780046336,z=141782544
seed=219245892,x=11264836736,z=-113178720
seed=3823830947,x=10345286896,z=-86890736
seed=704485627,x=13685927072,z=148058528
seed=-647835136,x=5426548256,z=-113770784
seed=1059255574,x=3317566672,z=17354656
seed=1733587205,x=7529398080,z=-83288512
seed=3699024964,x=8794664416,z=-58362896
seed=2264487793,x=2585153920,z=134847840
seed=-1826088964,x=672438176,z=-146204528
seed=3715939416,x=5926558848,z=96719344
seed=-714921290,x=8996290480,z=70231360
seed=-697425785,x=11434005584,z=-159144032
seed=1344536848,x=13400267776,z=-109443184
seed=1972974037,x=5714391584,z=-144925920
seed=-1889480870,x=1123663040,z=119792672
seed=-1478978425,x=1455786240,z=148480080
seed=-2077618072,x=14444065808,z=-100660944
seed=-1494932085,x=6616834368,z=-116120672
seed=-1841195394,x=7538740480,z=99855104
seed=79541918,x=2527404736,z=-102528944
seed=764832667,x=9044180528,z=-14747456
seed=-2335703718,x=16217741232,z=157093488
seed=-149367352,x=596341856,z=-108012624
seed=-2900463171,x=14881180608,z=-47491232
seed=-383817457,x=11277871984,z=-80331120
seed=1636982464,x=6869299264,z=98966832
```