# 史莱姆区块课题〔1〕：基本原理与 2×n 联寻找

## 前言

我们知道，在 Minecraft 中史莱姆是一种很重要的生物，查看 wiki 可以发现：
> 史莱姆生成在40层以下的特定的“史莱姆区块”里（不限亮度）。

于是想要制造高效率的史莱姆农场就需要一片较大的多联史莱姆区块。  
但是由于现版本渗浆药水的存在，该任务就变成了一个纯粹的理论课题。

*※ 本文主要的代码语言是 c++ 风格，这比较简洁高效。*  
*※ 本文将会不断更新，会尽量满足各种水平的人阅读。*

## 核心想法

为了方便普罗大众的理解，我先给出一个较为浅显的理解方式：

对于史莱姆区块的判定，你可以理解为这是一个可以分离变量的函数：
$${\rm CheckSlimeChunk}(seed,x,z)=H(seed+f(x)+g(z))$$

这里的 $seed,x,z$ 分别指的是 世界种子，区块 X 轴坐标，区块 Z 轴坐标。  
于是我们可以定义：
$${\rm Check}(c,z)=H(c+g(z))$$

那么固定一个 $c$，我们就得到了一列史莱姆区块，  
我们把这列史莱姆区块称为编号为 $c$ 的史莱姆列。

由于 $f(x)$ 是 $[-2^{31},2^{31}-1]$ 到 $[-2^{32},2^{32}-2]$ 的单射，对于种子 $seed$，  
它就是选择一半 $c=[seed-2^{32},seed+2^{32}-2]$ 的史莱姆列，重新排列后的结果。

也就是说只要我们找到了两个史莱姆列，它们并在一起可以产生 $2\times n$ 联的史莱姆区块，  
我们就尝试可以求解 $seed,x$，得到真正的 $2\times n$ 联的史莱姆区块。

## 技术细节

### 史莱姆区块的判定

查看 wiki，我们能知道史莱姆区块的判定代码：

```java
import java.util.Random; 

public class CheckSlimeChunk { 

    public static boolean isSlimeChunk(long worldSeed,     // 世界种子，一个64位整数，可以通过/seed获取
                                       int  chunkX,        // 区块X轴坐标，32位整数
                                       int  chunkZ) {      // 区块Z轴坐标，32位整数
        Random rng = new Random(
                        worldSeed +
                        (long)(chunkX * chunkX * 4987142) +
                        (long)(chunkX * 5947611) +
                        (long)(chunkZ * chunkZ) * 4392871L +
                        (long)(chunkZ * 389711) ^ 987234911L
        );
        return rng.nextInt(10) == 0;
    }
}
```

可以注意到区块 $(x,z)$ 是史莱姆区块的概率为 $1/10$。  
因此某个 $n$ 个区块的特定图案均为史莱姆区块的概率仅为 $10^{-n}$。  
如果纯粹暴力的寻找，期望时间复杂度为 $O(n10^n)$。

仔细观察这个函数，你会发现很多坑人的细节：

1. 函数中的乘法都是先有符号 $32$ 位溢出，除了 `*4392871L` 要整形提升。
2. Java 的有符号 $32$ 位溢出是 `-fwrapv` 的回绕溢出。

`Random()` 的实现可以看做（c++ 风格）：  
`rng=(rng^Ox5DEECE66D)&((1LL<<48)-1);`  

`nextInt(10)` 的实现可以看做：  
`next()=rng: rng=((rng*0x5DEECE66D+11)&((1LL<<48)-1))>>17;`  
`nextInt(10)=rng%10: while(next()>=2147483640);`  

$$\red{\Large\mathtt{TODO.}}$$

但是满足 `rng>=2147483640` 的情况只有 $8$ 个，我们可以直接看做：  
`nextInt(10)=(((rng*0x5DEECE66D+11)&((1LL<<48)-1))>>17)%10;`

$$\red{\Large\mathtt{TODO.}}$$

---
### 判定函数的数学分析

正如上文所述，我们可以分离变量：
$${\rm CheckSlimeChunk}(seed,x,z)=H(seed+f(x)+g(z))$$

这里我们具体分析一下，整个讨论都是整数意义下的，后文就不再赘述了。  

由于 $H(x)$ 过于复杂我们先不做讨论。  
定义 $R(x)$ 为 `-fwrapv` 意义下 32 位有符号整数的溢出:
$$
\begin{aligned}
R(x)&=\begin{cases}
x\bmod2^{32}, &x\bmod2^{32}<2^{31}\\
x\bmod2^{32}-2^{32}, &x\bmod2^{32}\ge2^{31}
\end{cases}
\end{aligned}
$$

该运算和 $\bmod$ 运算性质很像，满足 $R(a+b)=R(R(a)+R(b))$，  
但注意 $R(a)+R(b)\neq R(R(a)+R(b))$，  
于是 $f(x),g(x)$ 为：
$$
\begin{aligned}
f(x)&=R(4987142x^2)+R(5947611x)\\
g(x)&=4392871R(x^2)+R(389711x)\\
\end{aligned}
$$

根据代码，$f,g$ 的定义域都是 $[-2^{31},2^{31}-1]$，  
根据 $R(x)$ 的性质，$f$ 的值域属于 $[-2^{32},2^{32}-2]$，但 $g$ 的值域相当大。  

---

接下来我们用反证法证明 $f,g$ 都是单射。

若存在 $f(x)=f(y)$，则：
$$
\begin{aligned}
f(x)&\equiv f(y)\pmod{2^{32}}\\
4987142(x^2-y^2)+5947611(x-y)&\equiv0\pmod{2^{32}}\\
(x-y)(4987142(x+y)+5947611)&\equiv0\pmod{2^{32}}\\
\end{aligned}
$$
由于 $4987142(x+y)-5947611$ 恒为奇数，  
因此 $2^{32}\mid x-y$，矛盾，无解。

$g(x)$ 的不会证，但我写代码验证了（雾）。

---
### 思路

正如上文所述，我们可以定义编号为 $c$ 的史莱姆列，这一列的数组为：
$$P_c[z]=H(c+g(z))$$
不妨让 $z\in[0,B]$，我们只去判定这些史莱姆区块。  
连续 $n$ 项都为 $1$ 的概率只有 $10^{-n}$，我们可以将这 $O(B10^{-n})$ 项记录下来。

如果有两列 $c_1,c_2$ 记录了同样的 $z$，  
这意味着如果把这两列并在一起，我们就找到了一个 $2\times n$ 联的史莱姆区块。  
只要解出该方程的 $seed,x$ 即可。
$$\begin{cases}
seed+f(x)=c_1\\
seed+f(x+1)=c_2
\end{cases}$$

根据上文分析，一个种子会产生 $2^{32}$ 个不同的 $c$。  
简单分析可以发现，一个种子会产生略小于 $2^{31}$ 个不同的 $c_2-c_1$。  
交换 $c_1,c_2$，这样就有 $2^{32}$ 个不同的 $c_2-c_1$ 了。  
于是找不到解的概率只有 $\frac12$。

对于种子 $seed$，它就是选择一半 $c=[seed-2^{32},seed+2^{32}-2]$ 的史莱姆列，重新排列后的结果。  
因此对于一对 $c_1-c_2\in[-2^{32},2^{32}]$，期望能找到一组 $seed,x$。  

如果我们考虑对行计算 $H(f(x)+c')$，我们就需要解 $g(x)$，  
同样的分析，对于 $\frac{c_1-c_2}{4392871}\in[-2^{31},2^{31}]$，期望只能找到 $\frac{2}{4392871}$ 组解，  
这个概率太低了，因此我们不采用这种方式。

---
我们具体分析一下“时间复杂度”：  

对于某一列来说，要判断 $B+1$ 个位置，记录的项只有 $B-n$ 种可能。  
我们令 $c$ 是从 $0$ 开始递增的，花费 $O(c(B+1))$ 的时间，期望记录 $\frac{c(B-n)}{10^n}$ 个数字。  
具体时间复杂度要分两类讨论：

当 $c<2^{33}$ 时：  
期望能找到 $\frac{c^2(B-n)}{2\times10^{2n}}$ 组 $c_1,c_2$，相当于有 $\frac{c^2(B-n)}{2\times10^{2n}}$ 组解。  
换句话说就是画花 $T$ 的时间，找到 $\frac{T^2(B-n)}{2\times10^{2n}B^2}$ 组解。  
此时取 $B=2n$ 最优，能找到 $\frac{T^2}{8n\times10^{2n}}$ 组解。  

当 $c\ge2^{33}$ 时：  
$c$ 递增到 $c_0$ 时，我们需要删掉 $c'<c_0-2^{33}$ 的 $c'$，  
期望能找到 $\frac{2^{65}(c-2^{33})(B-n)^2}{10^{3n}}$ 组 $c_1,c_2$，相当于有 $\frac{2^{65}(c-2^{33})(B-n)^2}{10^{3n}}$ 组解。  
换句话说就是画花 $T$ 的时间，找到 $\frac{2^{65}(T-2^{33}B)(B-n)^2}{10^{3n}B}$ 组解。  
此时取 $B$ 较大时最优，但可能也优不到哪里去。  
*※ 感觉这一部分分析的有问题，求大佬们捞捞。*

综上，我建议 $B$ 取一个较小的常数，  
如果愿意接受第一部分比较慢的速度，$B$ 也可以取的比较大。

---
### 解方程

$$
\begin{aligned}
&\begin{cases}
seed+f(x)=c_1\\
seed+f(x+1)=c_2
\end{cases}\\
\Rightarrow\ &f(x+1)-f(x)\equiv c_2-c_1\pmod{2^{32}}
\end{aligned}
$$

$$
\begin{aligned}
f(x)&=R(4987142x^2)+R(5947611x)\\
\Rightarrow f(x)&\equiv4987142x^2+5947611x\pmod{2^{32}}\\
\Rightarrow f(x+1)-f(x)&\equiv9974284x+10934753\pmod{2^{32}}
\end{aligned}
$$

定义 $\delta=c_2-c_1$，于是：
$$\delta\equiv9974284x+10934753\pmod{2^{32}}$$
由于 $v_2(9974284)=2$，方程有解一个必要条件是 $\delta\equiv1\pmod4$，解：
$$x_0\equiv\frac{\delta-10934753}{9974284}\equiv381395499\frac{\delta-10934753}4\pmod{2^{30}}$$

由于 $x\in[-2^{31},2^{31}-1]$，因此我们只用判断这 $4$ 个解是否正确即可：
$$x_0-2^{31},x_0-2^{30},x_0,x_0+2^{30}$$

由于 $f(x)\in[-2^{32},2^{32}-2]$，  
这四个解要么就是 $\delta\bmod 2^{32}$，要么就是 $\delta\bmod 2^{32}+2^{32}$。

总而言之，对于某个 $\delta$，有 $\frac14$ 的概率有解，有解时期望有 $2$ 个解。  
考虑 $-\delta$，这里也能分析出期望有一个解。  
如果把 $f$ 换成 $g$ 这个方法就不行了，分析同上，$g$ 有解的概率太低了。

# 史莱姆区块课题〔2〕：3×n 联寻找

